<!DOCTYPE html>

<!-- Sample implementation of a chat:configuration module -->

<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>App Configuration</title>

    <!-- Import AtlasKit: https://atlaskit.atlassian.com -->
    <link rel="stylesheet" href="node_modules/@atlaskit/css-reset/dist/bundle.css" />
    <link rel="stylesheet" href="node_modules/@atlaskit/reduced-ui-pack/dist/bundle.css" />

    <!-- Import JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Import the Stride Javascript API -->
    <script src='https://dev-lib.stride.com/javascript/simple-xdm.js'></script>

    <script>
        $(document).ready(function() {

            /**
             * Load configuration settings from the app backend for this conversation
             */
            AP.auth.withToken(function(err, token) {
                $.ajax({
                    type: 'GET',
                    url: '/module/config/content',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    dataType: 'json',
                    success: function(data) {
                        var notificationLevel = data.notificationLevel;
                        switch (notificationLevel) {
                            case "INSTANT":
                                $("#option1").prop("checked", true);
                                break;
                            case "DAILY":
                                $("#option2").prop("checked", true);
                                break;
                            default:
                                $("#option3").prop("checked", true);
                        }
                    },
                    error: function(data) {
                        console.log(data);
                    }
                });
            });

            /**
             * Call the app backend to save configuration settings when the user clicks on the "Save" action
             */
            AP.register({
                "dialog-button-clicked": function(event, closeDialog) {
                    if (event.action === "action-save") {

                        //events are currently processed synchronously in the JavaScript API. Using this makes sure the dialog
                        //doesn't close before the AJAX call completes
                        closeDialog(false);

                        var notificationLevel = $("input[id=option1]:checked").val() ? "INSTANT" :
                            $("input[id=option2]:checked").val() ? "DAILY" : "NONE";

                        AP.auth.withToken(function(err, token) {
                            $.ajax({
                                type: 'POST',
                                url: '/module/config/content',
                                headers: {
                                    'Authorization': 'Bearer ' + token
                                },
                                data: {
                                    'notificationLevel': notificationLevel
                                },
                                dataType: 'json',
                                success: function(data) {
                                    console.log("saved settings");
                                    AP.dialog.close();
                                },
                                error: function(data) {
                                    console.log("Error" + data);
                                }
                            });
                        });

                    }
                    if (event.action === "action-close") {
                        console.log("closing dialog")
                    }
                }
            })
        });

        function connectToProvider() {
            AP.auth.withToken(function(err, token) {
                window.open("/login/salesforce?jwt=" + token);
            });
        }
    </script>
</head>

<body>
    <img src="https://login.salesforce.com/img/logo198.png" width="80">
    <p>
        Please use the below link to log in to Salesforce. After you're done, please close this dialog!
    </p>
    <div class="ak-button-group">
        <input type="button" class="ak-button" name="connect" value="Connect to Salesforce" id="connect1" onclick="connectToProvider()">
    </div>

    <hr />

    <p>
        To undo configuration state:
        <button class="ak-button">Unconfigure!</button>

    </p>
</body>

</html>